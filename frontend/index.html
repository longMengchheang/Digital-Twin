<!DOCTYPE html>
<html lang="en" class="dark" style="color-scheme: dark;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Digital Twin</title>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="./ui/sidebar.css">
  <link rel="stylesheet" href="./ui/checkin.css">
  <link rel="stylesheet" href="./ui/quest.css">
  <link rel="stylesheet" href="./ui/chat.css">
  <link rel="stylesheet" href="./ui/history.css">
  <link rel="stylesheet" href="./ui/profile.css">
  <link rel="stylesheet" href="./ui/insight.css">
  <link rel="stylesheet" href="./ui/settings.css">
  <link rel="stylesheet" href="./auth.css">
</head>
<body>
  <!-- Auth -->
  <div id="auth-container" style="display: flex; justify-content: center; align-items: center; height: 100vh; width: 100%; background: hsl(210 25% 11%); position: fixed; top: 0; left: 0; z-index: 2000;"></div>

  <!-- Sidebar -->
  <div class="sidebar-wrapper" id="sidebar" style="display: none;">
    <!-- Header -->
    <div class="sidebar-header">
      <p>Digital Twin</p>
    </div>

    <!-- Main Chat Items (non-scrollable) -->
    <div class="main-chat-items">
      <div class="chat-item active" onclick="showSection('checkin')">
        <i data-lucide="home" class="chat-item-icon" style="color: hsl(48 96% 50%);"></i>
        <span>Daily Check In</span>
      </div>
      <div class="chat-item" onclick="showSection('quest')">
        <i data-lucide="target" class="chat-item-icon" style="color: hsl(350, 100%, 70%);"></i>
        <span>Quest</span>
      </div>
      <div class="chat-item" onclick="showSection('insight')">
        <i data-lucide="bar-chart-2" class="chat-item-icon" style="color: hsl(262 83% 58%);"></i>
        <span>Insight</span>
      </div>
      <div class="chat-item" onclick="showSection('chat')">
        <i data-lucide="message-circle" class="chat-item-icon" style="color: hsl(84 81% 44%);"></i>
        <span>Chat</span>
      </div>
    </div>

    <!-- Scrollable Content - for chat history -->
    <div class="scrollable-content">
      <div class="history-title">Recent Chats</div>
      <!-- Chat History -->
      <div class="chat-history">
        <div class="chat-item" onclick="showSection('history', 'Yesterday\'s Check In')">
          <i data-lucide="history" class="chat-item-icon"></i>
          <span>History Example</span>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="sidebar-footer">
      <div class="user-profile" onclick="showSection('profile')">
        <i data-lucide="user" class="chat-item-icon" style="color: hsl(218 91% 60%);"></i>
        <div class="user-name">Profile</div>
      </div>
      <button class="collapse-button" id="collapseButton">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 17L12 12L6 7" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content" id="main-content" style="display: none; display: flex; justify-content: center; align-items: center; text-align: center; width: calc(100% - var(--sidebar-width)); margin-left: var(--sidebar-width); z-index: 1000;">
    <div class="content-wrapper" style="max-width: 80%; text-align: center;">
      <div class="settings-button" onclick="showSection('settings')">
        <i data-lucide="settings" style="color: hsl(84 81% 44%); font-size: 24px;"></i>
      </div>
    </div>
  </div>

  <script>
    // auth
    function loadAuthForm() {
      const authContainer = document.getElementById('auth-container');
      fetch('/auth.html')
        .then(response => {
          if (!response.ok) throw new Error(`Failed to load auth.html: ${response.status}`);
          return response.text();
        })
        .then(html => {
          authContainer.innerHTML = html;
          lucide.createIcons();
          document.getElementById('login-form').style.display = 'block';
          document.getElementById('register-form').style.display = 'none';
          console.log('Auth form loaded successfully');
        })
        .catch(error => {
          console.error('Auth load error:', error);
          authContainer.innerHTML = `
            <div class="auth-form" style="text-align: center; width: 100%; max-width: 400px;">
              <h2>Digital Twin</h2>
              <input type="email" id="fallback-email" placeholder="Email" style="width: 80%; margin: 0.5rem auto;">
              <input type="password" id="fallback-password" placeholder="Password" style="width: 80%; margin: 0.5rem auto;">
              <button onclick="performFallbackLogin()" style="width: 80%; margin: 0.5rem auto;">Login</button>
              <button onclick="toggleFallbackForm('register')" style="width: 80%; margin: 0.5rem auto;">Register</button>
              <p id="fallback-message" style="color: red;"></p>
            </div>
          `;
        });
    }

    function toggleAuthForm(formType) {
      const loginForm = document.getElementById('login-form');
      const registerForm = document.getElementById('register-form');
      if (loginForm && registerForm) {
        loginForm.style.display = formType === 'login' ? 'block' : 'none';
        registerForm.style.display = formType === 'register' ? 'block' : 'none';
      }
    }

    function toggleFallbackForm(formType) {
      const container = document.getElementById('auth-container');
      if (formType === 'register') {
        container.innerHTML = `
          <div class="auth-form" style="text-align: center; width: 100%; max-width: 400px;">
            <h2>Register</h2>
            <input type="email" id="fallback-email" placeholder="Email" style="width: 80%; margin: 0.5rem auto;">
            <input type="password" id="fallback-password" placeholder="Password" style="width: 80%; margin: 0.5rem auto;">
            <button onclick="performFallbackRegister()" style="width: 80%; margin: 0.5rem auto;">Register</button>
            <button onclick="toggleFallbackForm('login')" style="width: 80%; margin: 0.5rem auto;">Login</button>
            <p id="fallback-message" style="color: red;"></p>
          </div>
        `;
      } else {
        container.innerHTML = `
          <div class="auth-form" style="text-align: center; width: 100%; max-width: 400px;">
            <h2>Login</h2>
            <input type="email" id="fallback-email" placeholder="Email" style="width: 80%; margin: 0.5rem auto;">
            <input type="password" id="fallback-password" placeholder="Password" style="width: 80%; margin: 0.5rem auto;">
            <button onclick="performFallbackLogin()" style="width: 80%; margin: 0.5rem auto;">Login</button>
            <button onclick="toggleFallbackForm('register')" style="width: 80%; margin: 0.5rem auto;">Register</button>
            <p id="fallback-message" style="color: red;"></p>
          </div>
        `;
      }
    }

    function performFallbackLogin() {
      const email = document.getElementById('fallback-email').value;
      const password = document.getElementById('fallback-password').value;
      const messageEl = document.getElementById('fallback-message');
      if (!email || !password) {
        messageEl.textContent = 'Email and password are required';
        messageEl.style.color = 'red';
        return;
      }
      fetch('http://localhost:5000/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      })
      .then(res => res.json())
      .then(data => {
        if (data.token) {
          localStorage.setItem('token', data.token);
          const authContainer = document.getElementById('auth-container');
          authContainer.style.opacity = '0';
          setTimeout(() => {
            authContainer.style.display = 'none';
            document.getElementById('sidebar').style.display = 'block';
            document.getElementById('main-content').style.display = 'block';
            showSection('checkin');
          }, 300); // Match this with the CSS transition if added
        } else {
          messageEl.textContent = data.msg || 'Login failed';
          messageEl.style.color = 'red';
        }
      })
      .catch(err => {
        console.error('Fallback login error:', err);
        messageEl.textContent = 'Failed to connect to server';
        messageEl.style.color = 'red';
      });
    }

    function performFallbackRegister() {
      const email = document.getElementById('fallback-email').value;
      const password = document.getElementById('fallback-password').value;
      const messageEl = document.getElementById('fallback-message');
      if (!email || !password) {
        messageEl.textContent = 'Email and password are required';
        messageEl.style.color = 'red';
        return;
      }
      fetch('http://localhost:5000/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      })
      .then(res => res.json())
      .then(data => {
        if (data.token) {
          localStorage.setItem('token', data.token);
          const messageEl = document.getElementById('fallback-message');
          messageEl.textContent = 'Registration successful! Logging in...';
          messageEl.style.color = 'green';
          setTimeout(() => {
            const authContainer = document.getElementById('auth-container');
            authContainer.style.opacity = '0';
            setTimeout(() => {
              authContainer.style.display = 'none';
              document.getElementById('sidebar').style.display = 'block';
              document.getElementById('main-content').style.display = 'block';
              showSection('checkin');
            }, 300); // Match this with the CSS transition if added
          }, 1000);
        } else {
          messageEl.textContent = data.msg || 'Registration failed';
          messageEl.style.color = 'red';
        }
      })
      .catch(err => {
        console.error('Fallback register error:', err);
        messageEl.textContent = 'Failed to connect to server';
        messageEl.style.color = 'red';
      });
    }

    function showSection(sectionId, chatTitle) {
      const mainContent = document.getElementById('main-content');
      if (!mainContent) {
        console.error('Main content element not found');
        return;
      }
      
      console.log(`Attempting to load section: ./sections/${sectionId}.html`);
      fetch(`./sections/${sectionId}.html`)
        .then(response => {
          console.log(`Fetch response for ${sectionId}: ${response.status} ${response.statusText}`);
          if (!response.ok) {
            throw new Error(`Failed to load ${sectionId}.html: ${response.status} ${response.statusText}`);
          }
          return response.text();
        })
        .then(html => {
          console.log(`Successfully loaded ${sectionId}`);
          mainContent.innerHTML = '';
          const contentWrapper = document.createElement('div');
          contentWrapper.className = 'content-wrapper';
          contentWrapper.style.maxWidth = '80%';
          contentWrapper.style.textAlign = 'center';
          if (chatTitle) {
            contentWrapper.innerHTML = `
              <h1>${chatTitle}</h1>
              <p>Details for ${chatTitle} would appear here...</p>
            `;
          } else {
            contentWrapper.innerHTML = html;
          }
          mainContent.appendChild(contentWrapper);
          mainContent.innerHTML += `
            <div class="settings-button" onclick="showSection('settings')">
              <i data-lucide="settings" style="color: hsl(84 81% 44%); font-size: 24px;"></i>
            </div>
          `;
          lucide.createIcons();
          
          // Initialize section-specific logic after a small delay
          setTimeout(() => {
            if (sectionId === 'checkin' && typeof initializeCheckIn === 'function') {
              console.log('Initializing checkin...');
              initializeCheckIn();
            } else if (sectionId === 'quest' && typeof initializeQuests === 'function') {
              console.log('Initializing quest...');
              initializeQuests();
            } else if (sectionId === 'chat' && typeof initializeChat === 'function') {
              console.log('Initializing chat...');
              initializeChat();
            } else if (sectionId === 'history' && typeof initializeHistory === 'function') {
              console.log('Initializing history...');
              initializeHistory();
            } else if (sectionId === 'profile' && typeof initializeProfile === 'function') {
              console.log('Initializing profile...');
              initializeProfile();
            } else if (sectionId === 'settings' && typeof initializeSettings === 'function') {
              console.log('Initializing settings...');
              initializeSettings();
            } else {
              console.warn(`No initialization function found for ${sectionId}`);
            }
            
            // Refresh icons after initialization
            lucide.createIcons();
          }, 50);
        })
        .catch(error => {
          console.error('Error loading section:', error);
          mainContent.innerHTML = `
            <div class="content-wrapper" style="max-width: 80%; text-align: center;">
              <p>Error loading section: ${error.message}. Please check if ./sections/${sectionId}.html exists and try again.</p>
            </div>
            <div class="settings-button" onclick="showSection('settings')">
              <i data-lucide="settings" style="color: hsl(84 81% 44%); font-size: 24px;"></i>
            </div>
          `;
        });

      // Update active button styling
      document.querySelectorAll('.chat-item').forEach(button => {
        button.classList.remove('active');
        const icon = button.querySelector('.chat-item-icon');
        const btnSection = button.getAttribute('onclick').match(/'([^']+)'/)[1];
        const iconColors = {
          'checkin': 'hsl(48 96% 50%)',
          'quest': 'hsl(350, 100%, 70%)',
          'insight': 'hsl(262 83% 58%)',
          'chat': 'hsl(84 81% 44%)',
          'history': 'hsl(210 40% 98%)',
          'profile': 'hsl(218 91% 60%)',
          'settings': 'hsl(84 81% 44%)'
        };
        icon.style.color = iconColors[btnSection] || 'hsl(210 40% 98%)';
      });
      
      const activeButton = document.querySelector(`.chat-item[onclick="showSection('${sectionId}')"]`);
      if (activeButton) {
        activeButton.classList.add('active');
        activeButton.querySelector('.chat-item-icon').style.color = 'hsl(84 81% 44%)';
      } else {
        console.warn(`No button found for section: ${sectionId}`);
      }
    }

    // Toggle sidebar collapse
    document.getElementById('collapseButton').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('main-content');
      sidebar.classList.toggle('collapsed');
      this.querySelector('svg').style.transform = sidebar.classList.contains('collapsed') 
        ? 'rotate(180deg)' 
        : 'rotate(0deg)';
      mainContent.style.width = sidebar.classList.contains('collapsed') 
        ? 'calc(100% - var(--sidebar-width-icon))' 
        : 'calc(100% - var(--sidebar-width))';
      mainContent.style.marginLeft = sidebar.classList.contains('collapsed') 
        ? 'var(--sidebar-width-icon)' 
        : 'var(--sidebar-width)';
    });

    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded - loading auth form, initializing default section: checkin');
      loadAuthForm();
      lucide.createIcons();
    });    

  </script>
  <script src="./public/auth.js"></script>
  <script src="./logic/checkin.js"></script> 
  <script src="./logic/quest.js"></script>
  <script src="./logic/chat.js"></script>
  <script src="./logic/history.js"></script>
  <script src="./logic/profile.js"></script>
  <script src="./logic/insight.js"></script>
  <script src="./logic/settings.js"></script>
</body>
</html>